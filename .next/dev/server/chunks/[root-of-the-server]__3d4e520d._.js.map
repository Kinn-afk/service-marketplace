{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/zero1/service-marketplace/lib/db.js"],"sourcesContent":["import mysql from 'mysql2/promise';\r\n\r\nconst pool = mysql.createPool({\r\n  host: 'localhost',\r\n  user: 'root',\r\n  password: '', \r\n  database: 'service_marketplace',\r\n  waitForConnections: true,\r\n  connectionLimit: 10,\r\n  queueLimit: 0\r\n});\r\n\r\nexport default pool;\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,OAAO,wKAAK,CAAC,UAAU,CAAC;IAC5B,MAAM;IACN,MAAM;IACN,UAAU;IACV,UAAU;IACV,oBAAoB;IACpB,iBAAiB;IACjB,YAAY;AACd;uCAEe"}},
    {"offset": {"line": 138, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/zero1/service-marketplace/app/api/messages/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport db from '@/lib/db';\r\n\r\n// Get messages (conversations)\r\nexport async function GET(request) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const userId = searchParams.get('userId');\r\n    const conversationWith = searchParams.get('conversationWith');\r\n\r\n    if (!userId) {\r\n      return NextResponse.json({ error: 'User ID required' }, { status: 400 });\r\n    }\r\n\r\n    // Get specific conversation\r\n    if (conversationWith) {\r\n      const [messages] = await db.execute(`\r\n        SELECT m.*, \r\n               sender.name as sender_name,\r\n               receiver.name as receiver_name\r\n        FROM messages m\r\n        JOIN users sender ON m.sender_id = sender.id\r\n        JOIN users receiver ON m.receiver_id = receiver.id\r\n        WHERE (m.sender_id = ? AND m.receiver_id = ?) \r\n           OR (m.sender_id = ? AND m.receiver_id = ?)\r\n        ORDER BY m.created_at ASC\r\n      `, [userId, conversationWith, conversationWith, userId]);\r\n\r\n      // Mark messages as read\r\n      await db.execute(`\r\n        UPDATE messages \r\n        SET is_read = TRUE \r\n        WHERE receiver_id = ? AND sender_id = ? AND is_read = FALSE\r\n      `, [userId, conversationWith]);\r\n\r\n      return NextResponse.json({ messages });\r\n    }\r\n\r\n    // Get all conversations (unique users)\r\n    const [conversations] = await db.execute(`\r\n      SELECT DISTINCT\r\n        CASE\r\n          WHEN m.sender_id = ? THEN m.receiver_id\r\n          ELSE m.sender_id\r\n        END as user_id,\r\n        CASE\r\n          WHEN m.sender_id = ? THEN receiver.name\r\n          ELSE sender.name\r\n        END as user_name,\r\n        CASE\r\n          WHEN m.sender_id = ? THEN receiver.email\r\n          ELSE sender.email\r\n        END as user_email,\r\n        CASE\r\n          WHEN m.sender_id = ? THEN receiver.profile_image\r\n          ELSE sender.profile_image\r\n        END as user_profile_image,\r\n        (SELECT message FROM messages\r\n         WHERE (sender_id = ? AND receiver_id = user_id)\r\n            OR (sender_id = user_id AND receiver_id = ?)\r\n         ORDER BY created_at DESC LIMIT 1) as last_message,\r\n        (SELECT created_at FROM messages\r\n         WHERE (sender_id = ? AND receiver_id = user_id)\r\n            OR (sender_id = user_id AND receiver_id = ?)\r\n         ORDER BY created_at DESC LIMIT 1) as last_message_time,\r\n        (SELECT COUNT(*) FROM messages\r\n         WHERE sender_id = user_id AND receiver_id = ? AND is_read = FALSE) as unread_count\r\n      FROM messages m\r\n      JOIN users sender ON m.sender_id = sender.id\r\n      JOIN users receiver ON m.receiver_id = receiver.id\r\n      WHERE m.sender_id = ? OR m.receiver_id = ?\r\n      ORDER BY last_message_time DESC\r\n    `, [userId, userId, userId, userId, userId, userId, userId, userId, userId, userId, userId]);\r\n\r\n    return NextResponse.json({ conversations });\r\n  } catch (error) {\r\n    console.error('Messages fetch error:', error);\r\n    return NextResponse.json({ error: 'Failed to fetch messages' }, { status: 500 });\r\n  }\r\n}\r\n\r\n// Send message\r\nexport async function POST(request) {\r\n  try {\r\n    const { sender_id, receiver_id, message } = await request.json();\r\n\r\n    if (!sender_id || !receiver_id || !message) {\r\n      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });\r\n    }\r\n\r\n    if (message.trim().length === 0) {\r\n      return NextResponse.json({ error: 'Message cannot be empty' }, { status: 400 });\r\n    }\r\n\r\n    const [result] = await db.execute(\r\n      'INSERT INTO messages (sender_id, receiver_id, message) VALUES (?, ?, ?)',\r\n      [sender_id, receiver_id, message.trim()]\r\n    );\r\n\r\n    return NextResponse.json({ \r\n      message: 'Message sent', \r\n      messageId: result.insertId \r\n    }, { status: 201 });\r\n  } catch (error) {\r\n    console.error('Message send error:', error);\r\n    return NextResponse.json({ error: 'Failed to send message' }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAGO,eAAe,IAAI,OAAO;IAC/B,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,QAAQ,GAAG;QAC5C,MAAM,SAAS,aAAa,GAAG,CAAC;QAChC,MAAM,mBAAmB,aAAa,GAAG,CAAC;QAE1C,IAAI,CAAC,QAAQ;YACX,OAAO,0KAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmB,GAAG;gBAAE,QAAQ;YAAI;QACxE;QAEA,4BAA4B;QAC5B,IAAI,kBAAkB;YACpB,MAAM,CAAC,SAAS,GAAG,MAAM,gJAAE,CAAC,OAAO,CAAC,CAAC;;;;;;;;;;MAUrC,CAAC,EAAE;gBAAC;gBAAQ;gBAAkB;gBAAkB;aAAO;YAEvD,wBAAwB;YACxB,MAAM,gJAAE,CAAC,OAAO,CAAC,CAAC;;;;MAIlB,CAAC,EAAE;gBAAC;gBAAQ;aAAiB;YAE7B,OAAO,0KAAY,CAAC,IAAI,CAAC;gBAAE;YAAS;QACtC;QAEA,uCAAuC;QACvC,MAAM,CAAC,cAAc,GAAG,MAAM,gJAAE,CAAC,OAAO,CAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAiC1C,CAAC,EAAE;YAAC;YAAQ;YAAQ;YAAQ;YAAQ;YAAQ;YAAQ;YAAQ;YAAQ;YAAQ;YAAQ;SAAO;QAE3F,OAAO,0KAAY,CAAC,IAAI,CAAC;YAAE;QAAc;IAC3C,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yBAAyB;QACvC,OAAO,0KAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA2B,GAAG;YAAE,QAAQ;QAAI;IAChF;AACF;AAGO,eAAe,KAAK,OAAO;IAChC,IAAI;QACF,MAAM,EAAE,SAAS,EAAE,WAAW,EAAE,OAAO,EAAE,GAAG,MAAM,QAAQ,IAAI;QAE9D,IAAI,CAAC,aAAa,CAAC,eAAe,CAAC,SAAS;YAC1C,OAAO,0KAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0B,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,IAAI,QAAQ,IAAI,GAAG,MAAM,KAAK,GAAG;YAC/B,OAAO,0KAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0B,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QAEA,MAAM,CAAC,OAAO,GAAG,MAAM,gJAAE,CAAC,OAAO,CAC/B,2EACA;YAAC;YAAW;YAAa,QAAQ,IAAI;SAAG;QAG1C,OAAO,0KAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,WAAW,OAAO,QAAQ;QAC5B,GAAG;YAAE,QAAQ;QAAI;IACnB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,uBAAuB;QACrC,OAAO,0KAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB,GAAG;YAAE,QAAQ;QAAI;IAC9E;AACF"}}]
}